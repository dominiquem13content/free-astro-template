---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/sections/Header.astro';
import Footer from '../components/sections/Footer.astro';
import { SITE_TITLE } from '../consts';
---

<!doctype html>
<html lang="en" data-theme="dark" class="dark">
<head>
  <BaseHead title={`Admin - ${SITE_TITLE}`} description="Blog content management system" />
</head>
<body>
  <Header />
  <main class="use-utility-layout mx-auto max-w-7xl px-3 py-5">
    <div class="flex flex-col lg:flex-row gap-6">
      <aside id="sidebar" class="lg:w-64 flex-shrink-0">
        <nav class="card-surface p-4 space-y-2 sticky top-4">
          <h2 class="text-xl font-bold mb-4">Admin Panel</h2>
          <button data-section="posts" class="admin-nav-btn w-full text-left px-4 py-2 rounded hover:bg-gray-700 transition active">
            Posts
          </button>
          <button data-section="authors" class="admin-nav-btn w-full text-left px-4 py-2 rounded hover:bg-gray-700 transition">
            Authors
          </button>
          <button data-section="categories" class="admin-nav-btn w-full text-left px-4 py-2 rounded hover:bg-gray-700 transition">
            Categories
          </button>
          <button data-section="tags" class="admin-nav-btn w-full text-left px-4 py-2 rounded hover:bg-gray-700 transition">
            Tags
          </button>
        </nav>
      </aside>

      <div id="main-content" class="flex-1 min-w-0">
        <div id="toast" class="hidden fixed top-4 right-4 px-6 py-3 rounded shadow-lg z-50"></div>

        <section id="posts-section" class="content-section">
          <div class="card-surface p-6">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold">Manage Posts</h1>
              <button id="new-post-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition">
                New Post
              </button>
            </div>
            <div id="posts-list"></div>
          </div>
          <div id="post-form-container" class="hidden mt-6 card-surface p-6"></div>
        </section>

        <section id="authors-section" class="content-section hidden">
          <div class="card-surface p-6">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold">Manage Authors</h1>
              <button id="new-author-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition">
                New Author
              </button>
            </div>
            <div id="authors-list"></div>
          </div>
          <div id="author-form-container" class="hidden mt-6 card-surface p-6"></div>
        </section>

        <section id="categories-section" class="content-section hidden">
          <div class="card-surface p-6">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold">Manage Categories</h1>
              <button id="new-category-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition">
                New Category
              </button>
            </div>
            <div id="categories-list"></div>
          </div>
          <div id="category-form-container" class="hidden mt-6 card-surface p-6"></div>
        </section>

        <section id="tags-section" class="content-section hidden">
          <div class="card-surface p-6">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold">Manage Tags</h1>
              <button id="new-tag-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded transition">
                New Tag
              </button>
            </div>
            <div id="tags-list"></div>
          </div>
          <div id="tag-form-container" class="hidden mt-6 card-surface p-6"></div>
        </section>
      </div>
    </div>
  </main>
  <Footer />

  <script>
    import { supabase, type Author, type Category, type Tag, type Post } from '../lib/supabase';
    import { generateSlug } from '../lib/markdown';

    let currentEditingPost: Post | null = null;
    let currentEditingAuthor: Author | null = null;
    let currentEditingCategory: Category | null = null;
    let currentEditingTag: Tag | null = null;

    function showToast(message: string, type: 'success' | 'error' = 'success') {
      const toast = document.getElementById('toast');
      if (!toast) return;

      toast.textContent = message;
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded shadow-lg z-50 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
      } text-white`;

      setTimeout(() => {
        toast.className = toast.className + ' hidden';
      }, 3000);
    }

    function switchSection(sectionName: string) {
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('hidden');
      });
      document.querySelectorAll('.admin-nav-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600');
      });

      const section = document.getElementById(`${sectionName}-section`);
      const btn = document.querySelector(`[data-section="${sectionName}"]`);

      if (section) section.classList.remove('hidden');
      if (btn) btn.classList.add('active', 'bg-blue-600');

      if (sectionName === 'posts') loadPosts();
      else if (sectionName === 'authors') loadAuthors();
      else if (sectionName === 'categories') loadCategories();
      else if (sectionName === 'tags') loadTags();
    }

    async function loadPosts() {
      const container = document.getElementById('posts-list');
      if (!container) return;

      container.innerHTML = '<p class="text-gray-400">Loading posts...</p>';

      try {
        const { data: posts, error } = await supabase
          .from('posts')
          .select(`
            *,
            author:authors(name),
            category:categories(name)
          `)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!posts || posts.length === 0) {
          container.innerHTML = '<p class="text-gray-400">No posts found. Create your first post!</p>';
          return;
        }

        container.innerHTML = `
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-gray-700">
                  <th class="text-left py-3 px-2">Title</th>
                  <th class="text-left py-3 px-2">Author</th>
                  <th class="text-left py-3 px-2">Category</th>
                  <th class="text-left py-3 px-2">Status</th>
                  <th class="text-left py-3 px-2">Date</th>
                  <th class="text-right py-3 px-2">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${posts.map(post => `
                  <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="py-3 px-2">${post.title}</td>
                    <td class="py-3 px-2">${post.author?.name || 'No author'}</td>
                    <td class="py-3 px-2">${post.category?.name || 'Uncategorized'}</td>
                    <td class="py-3 px-2">
                      <span class="px-2 py-1 rounded text-xs ${
                        post.published ? 'bg-green-600' : 'bg-gray-600'
                      }">
                        ${post.published ? 'Published' : 'Draft'}
                      </span>
                    </td>
                    <td class="py-3 px-2">${new Date(post.created_at).toLocaleDateString()}</td>
                    <td class="py-3 px-2 text-right space-x-2">
                      <button class="edit-post-btn px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition" data-id="${post.id}">
                        Edit
                      </button>
                      <button class="delete-post-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition" data-id="${post.id}">
                        Delete
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        document.querySelectorAll('.edit-post-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            await showPostForm(id);
          });
        });

        document.querySelectorAll('.delete-post-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            if (confirm('Are you sure you want to delete this post?')) {
              await deletePost(id!);
            }
          });
        });

      } catch (error) {
        console.error('Error loading posts:', error);
        container.innerHTML = '<p class="text-red-400">Error loading posts. Check console for details.</p>';
      }
    }

    async function showPostForm(postId?: string) {
      const container = document.getElementById('post-form-container');
      if (!container) return;

      currentEditingPost = null;
      let post: any = null;
      let postTags: string[] = [];

      if (postId) {
        const { data, error } = await supabase
          .from('posts')
          .select('*')
          .eq('id', postId)
          .single();

        if (error) {
          showToast('Error loading post', 'error');
          return;
        }

        currentEditingPost = data;
        post = data;

        const { data: tags } = await supabase
          .from('post_tags')
          .select('tag_id')
          .eq('post_id', postId);

        postTags = tags?.map(t => t.tag_id) || [];
      }

      const { data: authors } = await supabase.from('authors').select('*').order('name');
      const { data: categories } = await supabase.from('categories').select('*').order('name');
      const { data: tags } = await supabase.from('tags').select('*').order('name');

      container.innerHTML = `
        <h2 class="text-2xl font-bold mb-6">${post ? 'Edit Post' : 'New Post'}</h2>
        <form id="post-form" class="space-y-4">
          <div>
            <label class="block mb-2 font-medium">Title *</label>
            <input type="text" id="post-title" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${post?.title || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Slug *</label>
            <input type="text" id="post-slug" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${post?.slug || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Excerpt</label>
            <textarea id="post-excerpt" rows="3" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none">${post?.excerpt || ''}</textarea>
          </div>

          <div>
            <label class="block mb-2 font-medium">Content * (Markdown)</label>
            <textarea id="post-content" rows="12" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none font-mono text-sm" required placeholder="# Your post content in markdown...

**Bold text**, *italic text*, [links](https://example.com)

- List items
- More items">${post?.content || ''}</textarea>
          </div>

          <div>
            <label class="block mb-2 font-medium">Hero Image URL</label>
            <input type="url" id="post-hero-image" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" value="${post?.hero_image || ''}" placeholder="https://images.pexels.com/...">
          </div>

          <div>
            <label class="block mb-2 font-medium">Author *</label>
            <select id="post-author" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required>
              <option value="">Select an author</option>
              ${authors?.map(author => `
                <option value="${author.id}" ${post?.author_id === author.id ? 'selected' : ''}>
                  ${author.name}
                </option>
              `).join('') || ''}
            </select>
          </div>

          <div>
            <label class="block mb-2 font-medium">Category</label>
            <select id="post-category" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none">
              <option value="">No category</option>
              ${categories?.map(category => `
                <option value="${category.id}" ${post?.category_id === category.id ? 'selected' : ''}>
                  ${category.name}
                </option>
              `).join('') || ''}
            </select>
          </div>

          <div>
            <label class="block mb-2 font-medium">Tags</label>
            <div class="space-y-2">
              ${tags?.map(tag => `
                <label class="flex items-center space-x-2">
                  <input type="checkbox" class="post-tag-checkbox" value="${tag.id}" ${postTags.includes(tag.id) ? 'checked' : ''}>
                  <span>${tag.name}</span>
                </label>
              `).join('') || ''}
            </div>
          </div>

          <div>
            <label class="block mb-2 font-medium">Meta Title (SEO)</label>
            <input type="text" id="post-meta-title" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" value="${post?.meta_title || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Meta Description (SEO)</label>
            <textarea id="post-meta-description" rows="2" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none">${post?.meta_description || ''}</textarea>
          </div>

          <div>
            <label class="flex items-center space-x-2">
              <input type="checkbox" id="post-published" ${post?.published ? 'checked' : ''}>
              <span>Publish immediately</span>
            </label>
          </div>

          <div class="flex space-x-4">
            <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded transition">
              Save Post
            </button>
            <button type="button" id="cancel-post-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded transition">
              Cancel
            </button>
          </div>
        </form>
      `;

      container.classList.remove('hidden');
      container.scrollIntoView({ behavior: 'smooth' });

      const titleInput = document.getElementById('post-title') as HTMLInputElement;
      const slugInput = document.getElementById('post-slug') as HTMLInputElement;

      titleInput?.addEventListener('input', () => {
        if (!post) {
          slugInput.value = generateSlug(titleInput.value);
        }
      });

      document.getElementById('post-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        await savePost();
      });

      document.getElementById('cancel-post-btn')?.addEventListener('click', () => {
        container.classList.add('hidden');
        currentEditingPost = null;
      });
    }

    async function savePost() {
      try {
        const title = (document.getElementById('post-title') as HTMLInputElement).value;
        const slug = (document.getElementById('post-slug') as HTMLInputElement).value;
        const excerpt = (document.getElementById('post-excerpt') as HTMLTextAreaElement).value;
        const content = (document.getElementById('post-content') as HTMLTextAreaElement).value;
        const heroImage = (document.getElementById('post-hero-image') as HTMLInputElement).value;
        const authorId = (document.getElementById('post-author') as HTMLSelectElement).value;
        const categoryId = (document.getElementById('post-category') as HTMLSelectElement).value;
        const metaTitle = (document.getElementById('post-meta-title') as HTMLInputElement).value;
        const metaDescription = (document.getElementById('post-meta-description') as HTMLTextAreaElement).value;
        const published = (document.getElementById('post-published') as HTMLInputElement).checked;

        const selectedTags = Array.from(document.querySelectorAll('.post-tag-checkbox:checked'))
          .map(cb => (cb as HTMLInputElement).value);

        const postData = {
          title,
          slug,
          content,
          excerpt: excerpt || null,
          hero_image: heroImage || null,
          meta_title: metaTitle || null,
          meta_description: metaDescription || null,
          author_id: authorId,
          category_id: categoryId || null,
          published,
          published_at: published && !currentEditingPost?.published ? new Date().toISOString() : currentEditingPost?.published_at,
        };

        let postId: string;

        if (currentEditingPost) {
          const { error } = await supabase
            .from('posts')
            .update(postData)
            .eq('id', currentEditingPost.id);

          if (error) throw error;
          postId = currentEditingPost.id;

          await supabase.from('post_tags').delete().eq('post_id', postId);
        } else {
          const { data, error } = await supabase
            .from('posts')
            .insert(postData)
            .select()
            .single();

          if (error) throw error;
          postId = data.id;
        }

        if (selectedTags.length > 0) {
          const tagInserts = selectedTags.map(tagId => ({
            post_id: postId,
            tag_id: tagId,
          }));

          const { error: tagError } = await supabase
            .from('post_tags')
            .insert(tagInserts);

          if (tagError) throw tagError;
        }

        showToast(currentEditingPost ? 'Post updated successfully!' : 'Post created successfully!');
        document.getElementById('post-form-container')?.classList.add('hidden');
        currentEditingPost = null;
        await loadPosts();

      } catch (error) {
        console.error('Error saving post:', error);
        showToast('Error saving post. Check console for details.', 'error');
      }
    }

    async function deletePost(id: string) {
      try {
        const { error } = await supabase
          .from('posts')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('Post deleted successfully!');
        await loadPosts();
      } catch (error) {
        console.error('Error deleting post:', error);
        showToast('Error deleting post', 'error');
      }
    }

    async function loadAuthors() {
      const container = document.getElementById('authors-list');
      if (!container) return;

      container.innerHTML = '<p class="text-gray-400">Loading authors...</p>';

      try {
        const { data: authors, error } = await supabase
          .from('authors')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!authors || authors.length === 0) {
          container.innerHTML = '<p class="text-gray-400">No authors found.</p>';
          return;
        }

        container.innerHTML = `
          <div class="grid gap-4">
            ${authors.map(author => `
              <div class="border border-gray-700 rounded p-4 flex items-start justify-between hover:bg-gray-800/50">
                <div class="flex-1">
                  <h3 class="text-xl font-bold">${author.name}</h3>
                  <p class="text-gray-400 text-sm">${author.email}</p>
                  <p class="text-gray-300 mt-2">${author.bio || 'No bio'}</p>
                </div>
                <div class="flex space-x-2">
                  <button class="edit-author-btn px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition" data-id="${author.id}">
                    Edit
                  </button>
                  <button class="delete-author-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition" data-id="${author.id}">
                    Delete
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        document.querySelectorAll('.edit-author-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            await showAuthorForm(id);
          });
        });

        document.querySelectorAll('.delete-author-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            if (confirm('Are you sure you want to delete this author? All their posts will be affected.')) {
              await deleteAuthor(id!);
            }
          });
        });

      } catch (error) {
        console.error('Error loading authors:', error);
        container.innerHTML = '<p class="text-red-400">Error loading authors.</p>';
      }
    }

    async function showAuthorForm(authorId?: string) {
      const container = document.getElementById('author-form-container');
      if (!container) return;

      currentEditingAuthor = null;
      let author: Author | null = null;

      if (authorId) {
        const { data, error } = await supabase
          .from('authors')
          .select('*')
          .eq('id', authorId)
          .single();

        if (error) {
          showToast('Error loading author', 'error');
          return;
        }

        currentEditingAuthor = data;
        author = data;
      }

      container.innerHTML = `
        <h2 class="text-2xl font-bold mb-6">${author ? 'Edit Author' : 'New Author'}</h2>
        <form id="author-form" class="space-y-4">
          <div>
            <label class="block mb-2 font-medium">Name *</label>
            <input type="text" id="author-name" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${author?.name || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Email *</label>
            <input type="email" id="author-email" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${author?.email || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Slug *</label>
            <input type="text" id="author-slug" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${author?.slug || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Bio</label>
            <textarea id="author-bio" rows="4" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none">${author?.bio || ''}</textarea>
          </div>

          <div>
            <label class="block mb-2 font-medium">Avatar URL</label>
            <input type="url" id="author-avatar" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" value="${author?.avatar_url || ''}" placeholder="https://images.pexels.com/...">
          </div>

          <div class="flex space-x-4">
            <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded transition">
              Save Author
            </button>
            <button type="button" id="cancel-author-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded transition">
              Cancel
            </button>
          </div>
        </form>
      `;

      container.classList.remove('hidden');
      container.scrollIntoView({ behavior: 'smooth' });

      const nameInput = document.getElementById('author-name') as HTMLInputElement;
      const slugInput = document.getElementById('author-slug') as HTMLInputElement;

      nameInput?.addEventListener('input', () => {
        if (!author) {
          slugInput.value = generateSlug(nameInput.value);
        }
      });

      document.getElementById('author-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveAuthor();
      });

      document.getElementById('cancel-author-btn')?.addEventListener('click', () => {
        container.classList.add('hidden');
        currentEditingAuthor = null;
      });
    }

    async function saveAuthor() {
      try {
        const name = (document.getElementById('author-name') as HTMLInputElement).value;
        const email = (document.getElementById('author-email') as HTMLInputElement).value;
        const slug = (document.getElementById('author-slug') as HTMLInputElement).value;
        const bio = (document.getElementById('author-bio') as HTMLTextAreaElement).value;
        const avatarUrl = (document.getElementById('author-avatar') as HTMLInputElement).value;

        const authorData = {
          name,
          email,
          slug,
          bio: bio || null,
          avatar_url: avatarUrl || null,
        };

        if (currentEditingAuthor) {
          const { error } = await supabase
            .from('authors')
            .update(authorData)
            .eq('id', currentEditingAuthor.id);

          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('authors')
            .insert(authorData);

          if (error) throw error;
        }

        showToast(currentEditingAuthor ? 'Author updated successfully!' : 'Author created successfully!');
        document.getElementById('author-form-container')?.classList.add('hidden');
        currentEditingAuthor = null;
        await loadAuthors();

      } catch (error) {
        console.error('Error saving author:', error);
        showToast('Error saving author', 'error');
      }
    }

    async function deleteAuthor(id: string) {
      try {
        const { error } = await supabase
          .from('authors')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('Author deleted successfully!');
        await loadAuthors();
      } catch (error) {
        console.error('Error deleting author:', error);
        showToast('Error deleting author', 'error');
      }
    }

    async function loadCategories() {
      const container = document.getElementById('categories-list');
      if (!container) return;

      container.innerHTML = '<p class="text-gray-400">Loading categories...</p>';

      try {
        const { data: categories, error } = await supabase
          .from('categories')
          .select('*')
          .order('name');

        if (error) throw error;

        if (!categories || categories.length === 0) {
          container.innerHTML = '<p class="text-gray-400">No categories found.</p>';
          return;
        }

        container.innerHTML = `
          <div class="grid gap-4">
            ${categories.map(category => `
              <div class="border border-gray-700 rounded p-4 flex items-start justify-between hover:bg-gray-800/50">
                <div class="flex-1">
                  <h3 class="text-xl font-bold">${category.name}</h3>
                  <p class="text-gray-400 text-sm">Slug: ${category.slug}</p>
                  <p class="text-gray-300 mt-2">${category.description || 'No description'}</p>
                </div>
                <div class="flex space-x-2">
                  <button class="edit-category-btn px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition" data-id="${category.id}">
                    Edit
                  </button>
                  <button class="delete-category-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition" data-id="${category.id}">
                    Delete
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        document.querySelectorAll('.edit-category-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            await showCategoryForm(id);
          });
        });

        document.querySelectorAll('.delete-category-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            if (confirm('Are you sure you want to delete this category?')) {
              await deleteCategory(id!);
            }
          });
        });

      } catch (error) {
        console.error('Error loading categories:', error);
        container.innerHTML = '<p class="text-red-400">Error loading categories.</p>';
      }
    }

    async function showCategoryForm(categoryId?: string) {
      const container = document.getElementById('category-form-container');
      if (!container) return;

      currentEditingCategory = null;
      let category: Category | null = null;

      if (categoryId) {
        const { data, error } = await supabase
          .from('categories')
          .select('*')
          .eq('id', categoryId)
          .single();

        if (error) {
          showToast('Error loading category', 'error');
          return;
        }

        currentEditingCategory = data;
        category = data;
      }

      container.innerHTML = `
        <h2 class="text-2xl font-bold mb-6">${category ? 'Edit Category' : 'New Category'}</h2>
        <form id="category-form" class="space-y-4">
          <div>
            <label class="block mb-2 font-medium">Name *</label>
            <input type="text" id="category-name" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${category?.name || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Slug *</label>
            <input type="text" id="category-slug" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${category?.slug || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Description</label>
            <textarea id="category-description" rows="3" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none">${category?.description || ''}</textarea>
          </div>

          <div class="flex space-x-4">
            <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded transition">
              Save Category
            </button>
            <button type="button" id="cancel-category-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded transition">
              Cancel
            </button>
          </div>
        </form>
      `;

      container.classList.remove('hidden');
      container.scrollIntoView({ behavior: 'smooth' });

      const nameInput = document.getElementById('category-name') as HTMLInputElement;
      const slugInput = document.getElementById('category-slug') as HTMLInputElement;

      nameInput?.addEventListener('input', () => {
        if (!category) {
          slugInput.value = generateSlug(nameInput.value);
        }
      });

      document.getElementById('category-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveCategory();
      });

      document.getElementById('cancel-category-btn')?.addEventListener('click', () => {
        container.classList.add('hidden');
        currentEditingCategory = null;
      });
    }

    async function saveCategory() {
      try {
        const name = (document.getElementById('category-name') as HTMLInputElement).value;
        const slug = (document.getElementById('category-slug') as HTMLInputElement).value;
        const description = (document.getElementById('category-description') as HTMLTextAreaElement).value;

        const categoryData = {
          name,
          slug,
          description: description || null,
        };

        if (currentEditingCategory) {
          const { error } = await supabase
            .from('categories')
            .update(categoryData)
            .eq('id', currentEditingCategory.id);

          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('categories')
            .insert(categoryData);

          if (error) throw error;
        }

        showToast(currentEditingCategory ? 'Category updated successfully!' : 'Category created successfully!');
        document.getElementById('category-form-container')?.classList.add('hidden');
        currentEditingCategory = null;
        await loadCategories();

      } catch (error) {
        console.error('Error saving category:', error);
        showToast('Error saving category', 'error');
      }
    }

    async function deleteCategory(id: string) {
      try {
        const { error } = await supabase
          .from('categories')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('Category deleted successfully!');
        await loadCategories();
      } catch (error) {
        console.error('Error deleting category:', error);
        showToast('Error deleting category', 'error');
      }
    }

    async function loadTags() {
      const container = document.getElementById('tags-list');
      if (!container) return;

      container.innerHTML = '<p class="text-gray-400">Loading tags...</p>';

      try {
        const { data: tags, error } = await supabase
          .from('tags')
          .select('*')
          .order('name');

        if (error) throw error;

        if (!tags || tags.length === 0) {
          container.innerHTML = '<p class="text-gray-400">No tags found.</p>';
          return;
        }

        container.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${tags.map(tag => `
              <div class="border border-gray-700 rounded p-4 flex items-center justify-between hover:bg-gray-800/50">
                <div>
                  <h3 class="text-lg font-bold">${tag.name}</h3>
                  <p class="text-gray-400 text-sm">Slug: ${tag.slug}</p>
                </div>
                <div class="flex space-x-2">
                  <button class="edit-tag-btn px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition" data-id="${tag.id}">
                    Edit
                  </button>
                  <button class="delete-tag-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition" data-id="${tag.id}">
                    Delete
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        document.querySelectorAll('.edit-tag-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            await showTagForm(id);
          });
        });

        document.querySelectorAll('.delete-tag-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.target as HTMLElement).dataset.id;
            if (confirm('Are you sure you want to delete this tag?')) {
              await deleteTag(id!);
            }
          });
        });

      } catch (error) {
        console.error('Error loading tags:', error);
        container.innerHTML = '<p class="text-red-400">Error loading tags.</p>';
      }
    }

    async function showTagForm(tagId?: string) {
      const container = document.getElementById('tag-form-container');
      if (!container) return;

      currentEditingTag = null;
      let tag: Tag | null = null;

      if (tagId) {
        const { data, error } = await supabase
          .from('tags')
          .select('*')
          .eq('id', tagId)
          .single();

        if (error) {
          showToast('Error loading tag', 'error');
          return;
        }

        currentEditingTag = data;
        tag = data;
      }

      container.innerHTML = `
        <h2 class="text-2xl font-bold mb-6">${tag ? 'Edit Tag' : 'New Tag'}</h2>
        <form id="tag-form" class="space-y-4">
          <div>
            <label class="block mb-2 font-medium">Name *</label>
            <input type="text" id="tag-name" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${tag?.name || ''}">
          </div>

          <div>
            <label class="block mb-2 font-medium">Slug *</label>
            <input type="text" id="tag-slug" class="w-full px-4 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 focus:outline-none" required value="${tag?.slug || ''}">
          </div>

          <div class="flex space-x-4">
            <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded transition">
              Save Tag
            </button>
            <button type="button" id="cancel-tag-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded transition">
              Cancel
            </button>
          </div>
        </form>
      `;

      container.classList.remove('hidden');
      container.scrollIntoView({ behavior: 'smooth' });

      const nameInput = document.getElementById('tag-name') as HTMLInputElement;
      const slugInput = document.getElementById('tag-slug') as HTMLInputElement;

      nameInput?.addEventListener('input', () => {
        if (!tag) {
          slugInput.value = generateSlug(nameInput.value);
        }
      });

      document.getElementById('tag-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveTag();
      });

      document.getElementById('cancel-tag-btn')?.addEventListener('click', () => {
        container.classList.add('hidden');
        currentEditingTag = null;
      });
    }

    async function saveTag() {
      try {
        const name = (document.getElementById('tag-name') as HTMLInputElement).value;
        const slug = (document.getElementById('tag-slug') as HTMLInputElement).value;

        const tagData = {
          name,
          slug,
        };

        if (currentEditingTag) {
          const { error } = await supabase
            .from('tags')
            .update(tagData)
            .eq('id', currentEditingTag.id);

          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('tags')
            .insert(tagData);

          if (error) throw error;
        }

        showToast(currentEditingTag ? 'Tag updated successfully!' : 'Tag created successfully!');
        document.getElementById('tag-form-container')?.classList.add('hidden');
        currentEditingTag = null;
        await loadTags();

      } catch (error) {
        console.error('Error saving tag:', error);
        showToast('Error saving tag', 'error');
      }
    }

    async function deleteTag(id: string) {
      try {
        const { error } = await supabase
          .from('tags')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('Tag deleted successfully!');
        await loadTags();
      } catch (error) {
        console.error('Error deleting tag:', error);
        showToast('Error deleting tag', 'error');
      }
    }

    document.querySelectorAll('.admin-nav-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const section = (e.target as HTMLElement).dataset.section;
        if (section) switchSection(section);
      });
    });

    document.getElementById('new-post-btn')?.addEventListener('click', () => showPostForm());
    document.getElementById('new-author-btn')?.addEventListener('click', () => showAuthorForm());
    document.getElementById('new-category-btn')?.addEventListener('click', () => showCategoryForm());
    document.getElementById('new-tag-btn')?.addEventListener('click', () => showTagForm());

    loadPosts();
  </script>

  <style>
    .admin-nav-btn.active {
      background-color: rgb(37 99 235);
    }
  </style>
</body>
</html>
